[Linux](./Linux.md)

# Процессы

## Как действует процесс

**Процесс** — это среда выполнения для работы экземпляра программы.

**Программа может запускать программы**, по принципу: _родительский процесс_ запускает _дочерний процесс_.  
 При запуске ядро инициирует несколько задач в виде процессов и запускает программу `init`/`systemd` (PID 1)  
Ядро хранит информацию обо всех процессах, чтобы упорядочить их работу. Каждому процессу ядро присваивает _Process ID_ (PID), следит за выделенной памятью и готовностью процессов возобновить выполнение.

**PID 1** выполняет последовательность сценариев начальной загрузки из _`/etc`_, которые запускают системные службы(многие реализованы как daemon).
daemon — программа, работающая в фоновом режиме.

## Команды

`ps` — выводит список процессов, выполняющихся в текущий момент

- **TTY**(teletype) — информация об управляющем терминале процесса. Символ **_?_** указывает на отсутствие управляющего терминала
- **TIME** — объем процессорного времени, потребленного процессом.
- **STAT** — содержит информацию о текущем состоянии процесса.

| Состояние | Значение                                                                                                                                                                                                                                                                                                                                           |
| --------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| R         | Выполняется. Процесс выполняется или готов к выполнению.                                                                                                                                                                                                                                                                                           |
| S         | Приостановлен. Процесс временно не выполняется; скорее всего, находится в ожидании определенного события, такого как нажатие клавиши или прибытие пакета.                                                                                                                                                                                          |
| D         | Приостановлен без возможности прерывания. Процесс ожидает завершения операции ввода/вывода, например, дисковым устройством.                                                                                                                                                                                                                        |
| T         | Остановлен. Процесс принудительно остановлен.                                                                                                                                                                                                                                                                                                      |
| Z         | Недействующий процесс-«зомби». Это дочерний процесс, который завершился, но не был удален родителем.                                                                                                                                                                                                                                               |
| <         | Высокоприоритетный процесс. Существует возможность наиболее важным процессам выделить больше процессорного времени. Данное свойство процесса называется niceness (уступчивость). Про процессы с более высокими приоритетами говорят, что они менее уступчивы, потому что потребляют больше процессорного времени, оставляя меньше другим процессам |
| N         | Низкоприоритетный процесс. Процесс с низким приоритетом (или уступчивый процесс) получает процессорное время только после того, как будут обслужены процессы с более высоким приоритетом                                                                                                                                                           |

Параметры:  
 x —

`strace -p` _pid_ — отображают каждый системный вызов, выполняемый процессом, и каждый получаемый им сигнал. unix & linux 4.8

`top` — выводит задачи  
`jobs` — выводит список активных заданий  
`bg` — переводит задание в фоновый режим работы  
`fg` — переводит задание в режим работы на переднем плане

`kill` -сигнал PID — посылает сигнал процессу  
 Сигналы (kill -l — все сигналы):

| Номер | Имя             | Значение                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ----- | --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2     | INT (Interrupt) | Прервать. Выполняет ту же функцию, что и нажатие комбинации CTRL+C в терминале. Обычно приводит к завершению программы                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 3     | QUIT            | Выйти                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| 9     | KILL            | Уничтожить. Это специальный сигнал. В большинстве случаев программы могут сами решать, как реагировать на сигналы, вплоть до полного их игнорирования, но сигнал KILL в действительности никогда не передается целевой программе. Вместо этого ядро немедленно завершает указанный процесс. Когда процесс завершается таким способом, он не имеет возможности «прибрать за собой» или сохранить результаты своей работы. По этой причине сигнал KILL следует использовать только как крайнее средство, когда другие сигналы на завершение программы не приводят к желаемому результату |
| 11    | SEGV            | Ошибка сегментации. Этот сигнал посылается программе, предпринявшей попытку недопустимого обращения к памяти, то есть попытку выполнить запись в память, доступ к которой запрещен                                                                                                                                                                                                                                                                                                                                                                                                     |
| 15    | TERM            | Завершить. Это сигнал по умолчанию, посылаемый командой kill. Если программа достаточно «живая», чтобы принять этот сигнал, она завершится                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 18    | CONT            | Продолжить. Этот сигнал восстанавливает нормальную работу процесса после сигнала STOP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| 19    | STOP            | Приостановить. Этот сигнал заставляет процесс приостановиться, не завершаясь. Подобно сигналу KILL, он не передается целевому процессу и потому не может быть проигнорирован им                                                                                                                                                                                                                                                                                                                                                                                                        |
| 20    | TSTP            | Сигнал «стоп» с клавиатуры. Этот сигнал посылается терминалом после нажатия комбинации CTRL+Z. В отличие от сигнала STOP, TSTP передается программе, и программа может решить игнорировать его                                                                                                                                                                                                                                                                                                                                                                                         |
| 28    | WINCH           | Изменение окна. Этот сигнал посылается системой при изменении размеров окна терминала. Некоторые программы, такие как top и less, реагируют на этот сигнал, обновляя свой вывод в соответствии с новыми размерами окна терминала                                                                                                                                                                                                                                                                                                                                                       |

`killall [-u пользователь] [-сигнал] имя` — останавливает процессы по именам  
`shutdown` — останавливает или перезагружает систему

### Systemctl

`systemctl` — все активные юниты(службы, сокеты, уст-ва…)  
`systemctl enable` _postgres_ — запускать при загрузке  
`systemctl disable`_postgres_ — не запускать при загрузке  
`systemctl start` — запускает _юнит_  
`systemctl stop` — останавливает

`systemctl restart`— перезапускает/запускает

`systemctl status` — показывает состояние  
`systemctl kill`_шаблон_ — отправляет сигнал в модуль соответствующий _шаблону_

`systemctl isolate` _цель_ — Изменить режим работы на _целевой_  
`systemctl get-default` — цель при загрузке  
`systemctl set-default` — установить цель при загрузке  
`systemctl list-unit --type=target` — посмотреть все цели

`systemctl reboot` — перезагрузка компьютера

`systemctl daemon-reload` — перезагружает _модули_ и конфигурацию **systemctl**

### cron

`cron` — планировщик запуска команд

- запустить node как сервис управляемый **systemd**

  1. создать файл в `/etc/systemd/system/node-app.serivce`

     _node-app.service_

     ```
     [Unit]
     Description=Social Network app backend(nodeJS) daemon

     [Service]
     Environment=NODE_ENV=production
     Environment=PORT=3001
     Type=simple
     User=ubuntu
     Group=ubuntu
     ExecStart=/usr/bin/node /path/to/app
     Restart=always
     # Отправка логов syslog
     # StandardOutput=syslog
     # StandardError=syslog
     # SyslogIdentifier=myapp
     [Install]
     WantedBy=multi-user.target
     ```

  2. `systemd enable node-app`
  3. `systemd daemon-reload`
  4. `systemd start node-app`
